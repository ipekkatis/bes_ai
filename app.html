<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BESPortfÃ¶y AI - Åeffaf ve AkÄ±llÄ± Emeklilik</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
    
    <!-- BaÄŸÄ±mlÄ±lÄ±klar -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/react-is@18.2.0/umd/react-is.development.js"></script>
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .recharts-wrapper { width: 100% !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* Animasyonlar */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .bg-pattern { background-image: radial-gradient(#e5e7eb 1px, transparent 1px); background-size: 20px 20px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 antialiased bg-pattern">
    <div id="root"></div>

    <!-- FIREBASE MODÃœLÃœ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDkoPGu4kgieTtCg9Jst-hISZNiAoBM0kI",
            authDomain: "bes-website-3767a.firebaseapp.com",
            projectId: "bes-website-3767a",
            storageBucket: "bes-website-3767a.firebasestorage.app",
            messagingSenderId: "577330588788",
            appId: "1:577330588788:web:36904c3aaf0418d91c3521",
            measurementId: "G-9GBKEQV2L7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        try { const analytics = getAnalytics(app); } catch(e) { console.log("Analytics pasif:", e); }

        window.firebaseDB = db;
        window.firestoreMethods = { doc, setDoc, getDoc, updateDoc };
    </script>

    <!-- REACT UYGULAMASI -->
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const RechartsObj = window.Recharts || {};
        const { LineChart, Line, PieChart, Pie, Cell, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, AreaChart, Area, BarChart, Bar } = RechartsObj;

        // --- Ä°KONLAR ---
        const Icon = ({ path, color = "currentColor", size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
        );
        const Icons = {
            Database: (p) => <Icon {...p} path={<><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></>} />,
            TrendingUp: (p) => <Icon {...p} path={<><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></>} />,
            TrendingDown: (p) => <Icon {...p} path={<><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></>} />,
            Wallet: (p) => <Icon {...p} path={<><path d="M21 12V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-5"/><path d="M16 12h6"/></>} />,
            Briefcase: (p) => <Icon {...p} path={<><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></>} />,
            Zap: (p) => <Icon {...p} path={<><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></>} />,
            Calculator: (p) => <Icon {...p} path={<><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="16" y1="14" x2="16" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></>} />,
            LogOut: (p) => <Icon {...p} path={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></>} />,
            AlertCircle: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>} />,
            CheckCircle: (p) => <Icon {...p} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />,
            Shield: (p) => <Icon {...p} path={<><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></>} />,
            Brain: (p) => <Icon {...p} path={<><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></>} />
        };

        // --- GELÄ°ÅTÄ°RÄ°LMÄ°Å VERÄ° SETÄ° ---
        const generateHistory = (basePrice, volatility, trend) => {
            let price = basePrice * 0.6;
            const data = [];
            for (let i = 0; i < 60; i++) {
                const change = (Math.random() - 0.5) * volatility + trend;
                price = price * (1 + change);
                data.push({ month: i, value: price });
            }
            return data;
        };

        const BES_FUNDS = [
            { code: 'AGY', name: 'Aegon AltÄ±n BYF', unitPrice: 1.5234, return1Y: 58.3, category: 'AltÄ±n', riskLevel: 3, volatility: 'DÃ¼ÅŸÃ¼k', sharpe: 1.2, drawdown: '-8%', manager: 'Ahmet YÄ±lmaz', fee: '1.1%', history: generateHistory(1.5, 0.03, 0.015) },
            { code: 'AEE', name: 'AgeSA AltÄ±n BYF', unitPrice: 1.4872, return1Y: 57.8, category: 'AltÄ±n', riskLevel: 3, volatility: 'DÃ¼ÅŸÃ¼k', sharpe: 1.15, drawdown: '-9%', manager: 'AyÅŸe Demir', fee: '1.2%', history: generateHistory(1.4, 0.03, 0.014) },
            { code: 'HGS', name: 'Halk GÃ¼mÃ¼ÅŸ BYF', unitPrice: 0.9865, return1Y: 44.5, category: 'GÃ¼mÃ¼ÅŸ', riskLevel: 4, volatility: 'Orta', sharpe: 0.9, drawdown: '-15%', manager: 'Mehmet Ã–z', fee: '1.5%', history: generateHistory(0.9, 0.05, 0.012) },
            { code: 'AET', name: 'AgeSA Teknoloji BYF', unitPrice: 2.7891, return1Y: 82.1, category: 'Teknoloji', riskLevel: 5, volatility: 'YÃ¼ksek', sharpe: 1.8, drawdown: '-22%', manager: 'Canan Tekin', fee: '2.0%', history: generateHistory(2.7, 0.08, 0.02) },
            { code: 'KTE', name: 'KatÄ±lÄ±m Teknoloji BYF', unitPrice: 2.6543, return1Y: 79.5, category: 'Teknoloji', riskLevel: 5, volatility: 'YÃ¼ksek', sharpe: 1.7, drawdown: '-20%', manager: 'Burak Can', fee: '1.9%', history: generateHistory(2.6, 0.07, 0.019) },
            { code: 'AHS', name: 'Anadolu Hisse BYF', unitPrice: 3.1234, return1Y: 92.8, category: 'Hisse', riskLevel: 5, volatility: 'Ã‡ok YÃ¼ksek', sharpe: 1.9, drawdown: '-25%', manager: 'Elif Kaya', fee: '2.2%', history: generateHistory(3.1, 0.09, 0.022) },
            { code: 'KKT', name: 'KatÄ±lÄ±m KatkÄ± BYF', unitPrice: 1.4567, return1Y: 32.3, category: 'KatÄ±lÄ±m', riskLevel: 2, volatility: 'Ã‡ok DÃ¼ÅŸÃ¼k', sharpe: 0.8, drawdown: '-4%', manager: 'Selim Ak', fee: '0.8%', history: generateHistory(1.4, 0.01, 0.008) },
            { code: 'OKS', name: 'Otomatik KatÄ±lÄ±m Dengeli', unitPrice: 1.1234, return1Y: 45.2, category: 'DeÄŸiÅŸken', riskLevel: 3, volatility: 'Orta', sharpe: 1.3, drawdown: '-10%', manager: 'Zeynep Su', fee: '1.0%', history: generateHistory(1.1, 0.04, 0.01) },
        ];
        const COLORS = { 'AltÄ±n': '#eab308', 'GÃ¼mÃ¼ÅŸ': '#94a3b8', 'Teknoloji': '#3b82f6', 'Hisse': '#ef4444', 'KatÄ±lÄ±m': '#10b981', 'DeÄŸiÅŸken': '#8b5cf6' };

        // --- DATABASE SERVICE ---
        class DataService {
            constructor() { this.db = window.firebaseDB; }
            async saveUser(email, userData) {
                if (this.db) {
                    try { const { doc, setDoc } = window.firestoreMethods; await setDoc(doc(this.db, "users", email), userData); return true; } 
                    catch (e) { console.error(e); return false; }
                } else {
                    const users = JSON.parse(localStorage.getItem('besUsers') || '{}'); users[email] = userData; localStorage.setItem('besUsers', JSON.stringify(users)); return true;
                }
            }
            async getUser(email) {
                if (this.db) {
                    try { const { doc, getDoc } = window.firestoreMethods; const s = await getDoc(doc(this.db, "users", email)); return s.exists() ? s.data() : null; }
                    catch (e) { return null; }
                } else { const users = JSON.parse(localStorage.getItem('besUsers') || '{}'); return users[email] || null; }
            }
        }
        const db = new DataService();
        async function hashPassword(p) { const e = new TextEncoder(); const d = e.encode(p); const h = await crypto.subtle.digest('SHA-256', d); return Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join(''); }

        // --- YARDIMCI KOMPONENTLER ---
        const RiskBadge = ({ level }) => {
            const colors = { 1: 'bg-green-100 text-green-700', 2: 'bg-green-100 text-green-700', 3: 'bg-yellow-100 text-yellow-700', 4: 'bg-orange-100 text-orange-700', 5: 'bg-red-100 text-red-700' };
            return <span className={`px-2 py-1 rounded text-xs font-bold ${colors[level] || 'bg-gray-100'}`}>Risk: {level}/5</span>;
        };

        // --- ANA UYGULAMA ---
        function BESPortfolio() {
            const [user, setUser] = useState(null);
            const [screen, setScreen] = useState('welcome');
            const [tab, setTab] = useState('dashboard');
            const [selectedFund, setSelectedFund] = useState(null);
            const [showBasketModal, setShowBasketModal] = useState(false);
            const [toast, setToast] = useState(null);
            const [category, setCategory] = useState('TÃ¼mÃ¼');
            
            // Auth States
            const [loginEmail, setLoginEmail] = useState('');
            const [loginPassword, setLoginPassword] = useState('');
            const [regName, setRegName] = useState('');
            const [regEmail, setRegEmail] = useState('');
            const [regPassword, setRegPassword] = useState('');
            const [regAge, setRegAge] = useState('');
            const [regCodeInput, setRegCodeInput] = useState('');
            const [generatedCode, setGeneratedCode] = useState(null);
            const [isCodeSent, setIsCodeSent] = useState(false);
            const [forgotEmail, setForgotEmail] = useState('');

            // App States
            const [tradeAmount, setTradeAmount] = useState('');
            const [depositAmount, setDepositAmount] = useState('');
            const [simYears, setSimYears] = useState(10);
            const [simMonthly, setSimMonthly] = useState(2000);

            useEffect(() => { const u = localStorage.getItem('lastBESUser'); if (u) loadUser(u); }, []);

            const loadUser = async (email) => {
                const u = await db.getUser(email);
                if (u) {
                    const y = new Date().getFullYear();
                    // Joined date yoksa ekle (eski veriler iÃ§in)
                    if (!u.joinedDate) { u.joinedDate = new Date().toISOString(); await db.saveUser(email, u); }
                    if (u.lastCheckYear !== y) { u.fundSwitches = 0; u.lastCheckYear = y; await db.saveUser(email, u); }
                    setUser(u); setScreen('app');
                }
            };

            const showToast = (msg, type = 'success') => { setToast({ msg, type }); setTimeout(() => setToast(null), 3000); };
            const formatMoney = (a) => new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(a);

            const getRiskProfile = (age) => {
                if (age <= 30) return { level: 'aggressive', equity: 70, label: 'YÃ¼ksek Risk (Agresif)', desc: 'GenÃ§ yaÅŸÄ±nÄ±z avantajÄ±nÄ±z. YÃ¼ksek getiri potansiyelli fonlara odaklanÄ±n.' };
                if (age <= 45) return { level: 'moderate', equity: 50, label: 'Dengeli', desc: 'Birikimlerinizi bÃ¼yÃ¼tÃ¼rken riski dengeleyin.' };
                return { level: 'conservative', equity: 20, label: 'DÃ¼ÅŸÃ¼k Risk (Muhafazakar)', desc: 'EmekliliÄŸe yaklaÅŸÄ±rken anaparayÄ± korumaya odaklanÄ±n.' };
            };

            // --- FÄ°NANSAL MOTOR: PORTFÃ–Y DEÄERÄ° & ENFLASYON ETKÄ°SÄ° (YENÄ°) ---
            const portfolioValue = user ? user.portfolio.reduce((sum, item) => {
                const fund = BES_FUNDS.find(f => f.code === item.code);
                return sum + (fund ? item.units * fund.unitPrice : 0);
            }, 0) : 0;
            const totalAssets = user ? user.cash + portfolioValue : 0;

            const inflationImpact = useMemo(() => {
                if (!user) return null;
                const yearsInBES = user.joinedDate ? Math.max(0.1, (new Date() - new Date(user.joinedDate)) / (365 * 24 * 60 * 60 * 1000)) : 0.1;
                
                // Senaryo: %45 Enflasyon, %20 Mevduat Faizi
                const avgInflation = 0.45; 
                const bankInterest = 0.20; 
                
                // SatÄ±n Alma GÃ¼cÃ¼ (Reel DeÄŸer) KaybÄ± HesabÄ±
                // "EÄŸer paramÄ± BES'e koymasaydÄ±m ve bankada tutsaydÄ±m, enflasyona gÃ¶re deÄŸeri ne olurdu?"
                const realCashValue = user.totalDeposited * Math.pow((1 + bankInterest) / (1 + avgInflation), yearsInBES);
                
                // BES Sayesinde Korunan Tutar
                // (Mevcut BES VarlÄ±ÄŸÄ±) - (Bankadaki ErimiÅŸ Para)
                const savedAmount = totalAssets - realCashValue;
                const savedPercent = realCashValue > 0 ? ((savedAmount / realCashValue) * 100).toFixed(0) : 0;
                
                // AylÄ±k Nakit Erozyonu (KullanÄ±cÄ±nÄ±n boÅŸta duran parasÄ± ne kadar eriyor?)
                // Basit hesap: Nakit * (AylÄ±k Enflasyon - AylÄ±k Mevduat Getirisi FarkÄ±)
                // Enflasyon %45, Mevduat %20 -> Fark %25 yÄ±llÄ±k erime -> AylÄ±k ~%2 erime
                const monthlyLoss = user.cash * (0.02);

                return { cashValue: realCashValue, savedAmount, savedPercent, monthlyLoss };
            }, [user, totalAssets]);

            // --- AKILLI SEPET MANTIÄI ---
            const getSmartBaskets = (amount) => {
                return [
                    { id: 'safe', name: 'GÃ¼venli Liman', risk: 'DÃ¼ÅŸÃ¼k', desc: 'Enflasyona karÅŸÄ± korur, volatilite dÃ¼ÅŸÃ¼ktÃ¼r.', allocation: { 'AltÄ±n': 60, 'KatÄ±lÄ±m': 40 }, expectedReturn: '25% - 35%', scenario: { best: amount * 1.45, normal: amount * 1.30, worst: amount * 1.15 } },
                    { id: 'balanced', name: 'Dengeli BÃ¼yÃ¼me', risk: 'Orta', desc: 'Hem koruma hem de bÃ¼yÃ¼me hedefler.', allocation: { 'DeÄŸiÅŸken': 40, 'AltÄ±n': 30, 'Teknoloji': 30 }, expectedReturn: '40% - 60%', scenario: { best: amount * 1.70, normal: amount * 1.50, worst: amount * 1.20 } },
                    { id: 'growth', name: 'FÄ±rsat OdaklÄ±', risk: 'YÃ¼ksek', desc: 'Maksimum getiri iÃ§in hisse ve teknoloji aÄŸÄ±rlÄ±klÄ±.', allocation: { 'Hisse': 50, 'Teknoloji': 50 }, expectedReturn: '70% - 110%', scenario: { best: amount * 2.20, normal: amount * 1.80, worst: amount * 0.90 } }
                ];
            };

            const applyBasket = async (basketId, amount) => {
                const baskets = getSmartBaskets(amount);
                const basket = baskets.find(b => b.id === basketId);
                let remainingCash = user.cash;
                if (remainingCash < amount) return showToast('Bakiye yetersiz!', 'error');
                const newPortfolio = [...user.portfolio];
                Object.entries(basket.allocation).forEach(([cat, percent]) => {
                    const fundsInCat = BES_FUNDS.filter(f => f.category === cat);
                    const targetFund = fundsInCat[0]; 
                    const investAmt = amount * (percent / 100);
                    const units = investAmt / targetFund.unitPrice;
                    const existing = newPortfolio.find(p => p.code === targetFund.code);
                    if (existing) { existing.units += units; existing.totalInvested += investAmt; }
                    else { newPortfolio.push({ code: targetFund.code, units, totalInvested: investAmt, buyDate: new Date().toISOString() }); }
                });
                const updatedUser = { ...user, cash: user.cash - amount, portfolio: newPortfolio, fundSwitches: user.fundSwitches + 1 };
                await db.saveUser(user.email, updatedUser);
                setUser(updatedUser);
                setShowBasketModal(false);
                setDepositAmount('');
                showToast(`ğŸš€ ${basket.name} stratejisi baÅŸarÄ±yla uygulandÄ±!`);
            };

            // --- AUTH & Ä°ÅLEMLER ---
            const sendVerificationCode = () => { if (!regEmail.includes('@')) return showToast('GeÃ§ersiz e-posta', 'error'); setGeneratedCode('123456'); setIsCodeSent(true); showToast('Kod: 123456 (Demo)', 'success'); };
            const handleLogin = async () => { 
                const u = await db.getUser(loginEmail); 
                if (!u) return showToast('KullanÄ±cÄ± yok', 'error'); 
                if (u.passwordHash !== await hashPassword(loginPassword)) return showToast('HatalÄ± ÅŸifre', 'error');
                loadUser(loginEmail); localStorage.setItem('lastBESUser', loginEmail); 
            };
            const handleRegister = async () => {
                if (regCodeInput !== '123456') return showToast('Kod hatalÄ±', 'error');
                const u = { email: regEmail, fullName: regName, passwordHash: await hashPassword(regPassword), age: parseInt(regAge), cash: 0, portfolio: [], totalDeposited: 0, stateContribution: 0, fundSwitches: 0, lastCheckYear: new Date().getFullYear(), joinedDate: new Date().toISOString() };
                await db.saveUser(regEmail, u); setUser(u); localStorage.setItem('lastBESUser', regEmail); setScreen('app');
            };
            
            const executeDeposit = async () => {
                const amt = parseFloat(depositAmount);
                if (!amt || amt <= 0) return showToast('Tutar girin', 'error');
                const stateCont = amt * 0.30;
                const updated = { ...user, cash: user.cash + amt + stateCont, totalDeposited: user.totalDeposited + amt, stateContribution: user.stateContribution + stateCont };
                await db.saveUser(user.email, updated);
                setUser(updated);
                setSelectedFund(null);
                setShowBasketModal(true); 
            };

            const executeTrade = async () => {
                const amt = parseFloat(tradeAmount);
                if (user.cash < amt) return showToast('Yetersiz bakiye', 'error');
                const units = amt / selectedFund.unitPrice;
                const p = [...user.portfolio];
                const exist = p.find(x => x.code === selectedFund.code);
                if (exist) { exist.units += units; exist.totalInvested += amt; } else { p.push({ code: selectedFund.code, units, totalInvested: amt }); }
                const u = { ...user, cash: user.cash - amt, portfolio: p, fundSwitches: user.fundSwitches + 1 };
                await db.saveUser(user.email, u); setUser(u); setSelectedFund(null); showToast('Ä°ÅŸlem BaÅŸarÄ±lÄ±');
            };

            // --- AI SKORLAMA ---
            const calculateAIScore = (fund, age) => {
                let score = 50; 
                score += (fund.return1Y / 2); 
                if (age < 35 && fund.riskLevel >= 4) score += 20; 
                if (age > 50 && fund.riskLevel <= 2) score += 20; 
                score += (fund.sharpe * 5);
                return Math.min(100, Math.round(score));
            };

            // --- SÄ°MÃœLASYON VERÄ°SÄ° ---
            const simulationData = useMemo(() => {
                if (!user) return [];
                const profile = getRiskProfile(user.age);
                const returns = { 'aggressive': 0.08, 'moderate': 0.05, 'conservative': 0.02 };
                const monthlyRate = returns[profile.level] / 12;
                
                // KarÅŸÄ±laÅŸtÄ±rma iÃ§in mevduat oranÄ± (Reel deÄŸil nominal dÃ¼ÅŸÃ¼nelim basitlik iÃ§in ama burada reel Ã¼zerinden gidiyoruz)
                // SimÃ¼lasyon "Reel Getiri" Ã¼zerine kurulu olduÄŸu iÃ§in, "Nakit Tutmak" aslÄ±nda negatif reel getiri demektir.
                // Enflasyon %45, Mevduat %20 -> Reel Getiri yaklaÅŸÄ±k -%17.
                const cashRealRate = -0.17 / 12; 

                let currentBalance = user.cash + (user.portfolio.reduce((acc, i) => acc + (i.units * BES_FUNDS.find(x => x.code === i.code).unitPrice), 0));
                let cashScenarioBalance = currentBalance; // Sadece nakitte tutsaydÄ±

                const data = [];
                for (let year = 1; year <= simYears; year++) {
                    let yearlyStateCont = simMonthly * 12 * 0.30;
                    for(let m=0; m<12; m++) {
                        currentBalance = (currentBalance + simMonthly) * (1 + monthlyRate);
                        cashScenarioBalance = (cashScenarioBalance + simMonthly) * (1 + cashRealRate);
                    }
                    currentBalance += yearlyStateCont; // Devlet katkÄ±sÄ± sadece BES'te var
                    
                    data.push({ 
                        year: `YÄ±l ${year}`, 
                        tahmini: Math.round(currentBalance), 
                        anaPara: Math.round((user.totalDeposited || 0) + (simMonthly * 12 * year)),
                        mevduat: Math.round(cashScenarioBalance) // Nakitte/Mevduatta kalan para (eriyor)
                    });
                }
                return data;
            }, [user, simYears, simMonthly]);

            // --- AI TAVSÄ°YELERÄ° (GÃœNCELLENMÄ°Å) ---
            const recommendations = useMemo(() => {
                if (!user) return [];
                const recs = [];
                const profile = getRiskProfile(user.age);
                
                // 1. NAKÄ°T EROZYONU UYARISI (EN KRÄ°TÄ°K)
                if (user.cash > 1000) {
                    recs.push({
                        code: 'NAKÄ°T', 
                        action: 'buy', 
                        reason: `âš ï¸ DÄ°KKAT: HesabÄ±nÄ±zdaki nakit para enflasyon karÅŸÄ±sÄ±nda eriyor! Mevcut durumda aylÄ±k tahmini ${formatMoney(inflationImpact?.monthlyLoss || 0)} satÄ±n alma gÃ¼cÃ¼ kaybediyorsunuz. Acilen fona geÃ§melisiniz.`, 
                        priority: 'Kritik'
                    });
                }

                // 2. Profil BazlÄ± Ã–neriler
                const hasGold = user.portfolio.some(p => BES_FUNDS.find(f => f.code === p.code)?.category === 'AltÄ±n');
                const hasTech = user.portfolio.some(p => BES_FUNDS.find(f => f.code === p.code)?.category === 'Teknoloji');

                if (profile.level === 'aggressive') {
                    if (!hasTech) recs.push({ code: 'TEKNO', action: 'buy', reason: 'Agresif profiliniz iÃ§in teknoloji fonlarÄ± eksik.', priority: 'YÃ¼ksek' });
                } else {
                    if (!hasGold) recs.push({ code: 'ALTIN', action: 'buy', reason: 'Enflasyona karÅŸÄ± koruma kalkanÄ± olarak AltÄ±n fonu eklemelisiniz.', priority: 'YÃ¼ksek' });
                }
                const topFund = [...BES_FUNDS].sort((a,b) => b.return1Y - a.return1Y)[0];
                recs.push({ code: topFund.code, action: 'info', reason: `Son 1 yÄ±lÄ±n ÅŸampiyonu %${topFund.return1Y} getiri ile ${topFund.name}.`, priority: 'DÃ¼ÅŸÃ¼k' });
                return recs;
            }, [user, inflationImpact]);

            // RENDER: BASKET MODAL
            const BasketModal = () => {
                if (!showBasketModal) return null;
                const amt = parseFloat(depositAmount) || user.cash; 
                const baskets = getSmartBaskets(amt);
                return (
                    <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl w-full max-w-4xl p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
                            <div className="flex justify-between items-center mb-6">
                                <div><h2 className="text-2xl font-bold text-slate-900 flex items-center gap-2"><Icons.Brain className="text-indigo-600"/> Yapay Zeka Strateji Ã–nerileri</h2><p className="text-slate-500 text-sm">YatÄ±rdÄ±ÄŸÄ±nÄ±z {formatMoney(amt)} iÃ§in profilinize uygun 3 daÄŸÄ±lÄ±m hazÄ±rladÄ±k.</p></div>
                                <button onClick={() => setShowBasketModal(false)} className="text-slate-400 hover:text-red-500"><Icons.LogOut size={24}/></button>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                {baskets.map(basket => (
                                    <div key={basket.id} className="border border-slate-200 rounded-xl p-5 hover:border-indigo-300 transition hover:shadow-lg relative overflow-hidden group">
                                        <div className={`absolute top-0 left-0 w-full h-1 ${basket.id === 'growth' ? 'bg-red-500' : basket.id === 'balanced' ? 'bg-blue-500' : 'bg-green-500'}`}></div>
                                        <h3 className="font-bold text-lg mb-1">{basket.name}</h3>
                                        <span className="text-xs bg-slate-100 px-2 py-1 rounded text-slate-600">{basket.risk} Risk</span>
                                        <p className="text-xs text-slate-500 mt-2 min-h-[40px]">{basket.desc}</p>
                                        <div className="my-4 space-y-2">{Object.entries(basket.allocation).map(([k, v]) => (<div key={k} className="flex items-center justify-between text-sm"><span>{k}</span><div className="flex-1 mx-2 h-2 bg-slate-100 rounded-full overflow-hidden"><div style={{width: `${v}%`}} className={`h-full ${COLORS[k] ? '' : 'bg-slate-400'}`} style={{backgroundColor: COLORS[k]}}></div></div><span className="font-bold">%{v}</span></div>))}</div>
                                        <div className="bg-slate-50 p-3 rounded-lg mb-4 text-xs"><div className="flex justify-between mb-1"><span>Beklenen (1 YÄ±l):</span> <span className="font-bold text-indigo-600">{basket.expectedReturn}</span></div><div className="flex justify-between text-slate-400"><span>KÃ¶tÃ¼ Senaryo:</span> <span>{formatMoney(basket.scenario.worst)}</span></div><div className="flex justify-between text-emerald-600"><span>Ä°yi Senaryo:</span> <span>{formatMoney(basket.scenario.best)}</span></div></div>
                                        <button onClick={() => applyBasket(basket.id, amt)} className="w-full py-2 bg-slate-900 text-white rounded-lg font-semibold hover:bg-indigo-600 transition">Uygula</button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            };

            // RENDER: FUND DETAIL MODAL
            const FundDetailModal = () => {
                const [activeTab, setActiveTab] = useState('overview'); 
                if (!selectedFund || selectedFund === 'deposit') return null;
                const f = selectedFund;
                const aiScore = calculateAIScore(f, user.age);
                return (
                    <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl w-full max-w-2xl overflow-hidden shadow-2xl animate-fade-in flex flex-col max-h-[90vh]">
                            <div className="bg-slate-900 p-6 text-white shrink-0">
                                <div className="flex justify-between items-start"><div><h3 className="text-xl font-bold flex items-center gap-2">{f.name} <RiskBadge level={f.riskLevel}/></h3><div className="text-slate-400 text-sm mt-1">{f.code} â€¢ {f.category}</div></div><button onClick={() => setSelectedFund(null)} className="text-white/50 hover:text-white text-2xl">&times;</button></div>
                                <div className="flex gap-4 mt-6 text-sm font-medium border-b border-white/10 pb-1">{['Genel BakÄ±ÅŸ', 'Grafik & Analiz', 'AI Raporu', 'Ä°ÅŸlem'].map((t, i) => { const key = ['overview', 'chart', 'ai', 'trade'][i]; return <button key={key} onClick={() => setActiveTab(key)} className={`pb-2 transition ${activeTab === key ? 'text-white border-b-2 border-indigo-500' : 'text-slate-400 hover:text-white'}`}>{t}</button> })}</div>
                            </div>
                            <div className="p-6 overflow-y-auto">
                                {activeTab === 'overview' && ( <div className="grid grid-cols-2 gap-6"><div className="space-y-4"><div className="p-4 bg-slate-50 rounded-xl"><div className="text-xs text-slate-500">GÃ¼ncel Fiyat</div><div className="text-2xl font-bold text-slate-900">{f.unitPrice} â‚º</div></div><div className="p-4 bg-emerald-50 rounded-xl"><div className="text-xs text-emerald-700">YÄ±llÄ±k Getiri</div><div className="text-2xl font-bold text-emerald-600">%{f.return1Y}</div></div></div><div className="space-y-3 text-sm"><div className="flex justify-between border-b py-2"><span>YÃ¶netici:</span> <span className="font-medium">{f.manager}</span></div><div className="flex justify-between border-b py-2"><span>YÃ¶netim Ãœcreti:</span> <span className="font-medium">{f.fee}</span></div><div className="flex justify-between border-b py-2"><span>Sharpe OranÄ±:</span> <span className="font-medium bg-blue-100 px-2 rounded text-blue-700">{f.sharpe}</span></div><div className="flex justify-between border-b py-2"><span>Volatilite:</span> <span className="font-medium">{f.volatility}</span></div><div className="flex justify-between py-2"><span>Max DÃ¼ÅŸÃ¼ÅŸ:</span> <span className="font-medium text-red-500">{f.drawdown}</span></div></div></div> )}
                                {activeTab === 'chart' && ( <div className="h-64 w-full"><h4 className="font-bold mb-4 text-sm text-slate-500">Son 5 YÄ±l Performans SimÃ¼lasyonu</h4><ResponsiveContainer width="100%" height="100%"><AreaChart data={f.history}><defs><linearGradient id="colorVal" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#3b82f6" stopOpacity={0.3}/><stop offset="95%" stopColor="#3b82f6" stopOpacity={0}/></linearGradient></defs><CartesianGrid strokeDasharray="3 3" vertical={false} /><XAxis dataKey="month" hide /><YAxis domain={['auto', 'auto']} hide /><Tooltip formatter={(v) => v.toFixed(2) + ' â‚º'} /><Area type="monotone" dataKey="value" stroke="#3b82f6" fillOpacity={1} fill="url(#colorVal)" /></AreaChart></ResponsiveContainer><div className="mt-4 text-xs text-slate-400 bg-slate-50 p-2 rounded">âš ï¸ Bu grafik fonun geÃ§miÅŸ volatilite ve trend verilerine dayalÄ± simÃ¼lasyondur.</div></div> )}
                                {activeTab === 'ai' && ( <div><div className="flex items-center gap-4 mb-6"><div className={`w-16 h-16 rounded-full flex items-center justify-center text-xl font-bold text-white ${aiScore > 70 ? 'bg-emerald-500' : aiScore > 50 ? 'bg-yellow-500' : 'bg-red-500'}`}>{aiScore}</div><div><h4 className="font-bold text-lg">AI Uyumluluk Skoru</h4><p className="text-sm text-slate-500">Sizin profilinize ({user.age} yaÅŸ) gÃ¶re hesaplandÄ±.</p></div></div><h5 className="font-bold text-sm mb-3">Karar Matrizi</h5><div className="space-y-3 text-sm"><div className="flex items-center justify-between p-2 bg-slate-50 rounded"><span>ğŸ“Š Getiri PerformansÄ±</span><span className="font-mono text-green-600">+{Math.round(f.return1Y / 2)} puan</span></div><div className="flex items-center justify-between p-2 bg-slate-50 rounded"><span>âš–ï¸ Risk/Getiri Dengesi (Sharpe)</span><span className="font-mono text-green-600">+{Math.round(f.sharpe * 5)} puan</span></div><div className="flex items-center justify-between p-2 bg-slate-50 rounded"><span>ğŸ‘¤ YaÅŸ Grubu Uyumu</span><span className={`font-mono ${(user.age < 35 && f.riskLevel >=4) || (user.age > 50 && f.riskLevel <=2) ? 'text-green-600' : 'text-slate-400'}`}>{(user.age < 35 && f.riskLevel >=4) ? '+20 puan (GenÃ§/Risk)' : (user.age > 50 && f.riskLevel <=2) ? '+20 puan (Koruma)' : '0 puan'}</span></div></div></div> )}
                                {activeTab === 'trade' && ( <div><div className="mb-6"><label className="block text-sm font-bold mb-2">YatÄ±rÄ±m TutarÄ± (TL)</label><input type="number" value={tradeAmount} onChange={e => setTradeAmount(e.target.value)} className="w-full p-4 border rounded-xl text-lg font-bold" placeholder="0.00" /><div className="flex justify-between text-xs mt-2 text-slate-500"><span>Nakit: {formatMoney(user.cash)}</span><span>Birim Adet: {tradeAmount ? (tradeAmount / f.unitPrice).toFixed(2) : '0'}</span></div></div><button onClick={executeTrade} className="w-full py-4 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-200">Emri Onayla</button></div> )}
                            </div>
                        </div>
                    </div>
                );
            };

            if (screen !== 'app') {
                return (
                    <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                            <div className="text-center mb-8"><div className="mx-auto mb-4 w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center text-blue-600"><Icons.Brain size={32}/></div><h1 className="text-2xl font-bold text-slate-900">BESPortfÃ¶y AI</h1><p className="text-slate-500">AkÄ±llÄ± Strateji & Åeffaf YÃ¶netim</p></div>
                            {screen === 'welcome' && ( <div className="space-y-3"><button onClick={() => setScreen('login')} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">GiriÅŸ Yap</button><button onClick={() => setScreen('register')} className="w-full border py-3 rounded-xl font-bold">KayÄ±t Ol</button></div> )}
                            {(screen === 'login' || screen === 'register') && ( <div className="space-y-4">{screen === 'register' && <input type="text" placeholder="Ad Soyad" className="w-full p-3 border rounded-lg" value={regName} onChange={e=>setRegName(e.target.value)} />}<input type="email" placeholder="E-posta" className="w-full p-3 border rounded-lg" value={screen==='login'?loginEmail:regEmail} onChange={e=> screen==='login'?setLoginEmail(e.target.value):setRegEmail(e.target.value)} />{screen === 'register' && ( <div className="flex gap-2"><input type="text" placeholder="YaÅŸ" className="w-1/3 p-3 border rounded-lg" value={regAge} onChange={e=>setRegAge(e.target.value)} /><button onClick={sendVerificationCode} className="flex-1 bg-slate-100 rounded-lg text-sm">{isCodeSent ? 'Kod Gitti' : 'Kod GÃ¶nder'}</button></div> )}{isCodeSent && <input type="text" placeholder="Kod (123456)" className="w-full p-3 border border-green-200 rounded-lg bg-green-50" value={regCodeInput} onChange={e=>setRegCodeInput(e.target.value)} />}<input type="password" placeholder="Åifre" className="w-full p-3 border rounded-lg" value={screen==='login'?loginPassword:regPassword} onChange={e=> screen==='login'?setLoginPassword(e.target.value):setRegPassword(e.target.value)} /><button onClick={screen==='login' ? handleLogin : handleRegister} className="w-full bg-slate-900 text-white py-3 rounded-xl font-bold mt-4">{screen==='login'?'GiriÅŸ':'KaydÄ± Tamamla'}</button><button onClick={() => setScreen('welcome')} className="w-full text-sm text-slate-500 mt-2">Geri DÃ¶n</button></div> )}
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen pb-24 md:pb-0">
                    {toast && <div className="fixed top-4 right-4 z-[60] bg-slate-800 text-white px-6 py-3 rounded-full shadow-lg animate-fade-in flex items-center gap-2"><span>{toast.type==='error'?'âš ï¸':'âœ…'}</span>{toast.msg}</div>}
                    
                    <FundDetailModal />
                    <BasketModal />
                    {selectedFund === 'deposit' && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl">
                                <h2 className="text-xl font-bold mb-4">Para YatÄ±r & Strateji SeÃ§</h2>
                                <input type="number" value={depositAmount} onChange={e => setDepositAmount(e.target.value)} className="w-full p-4 border rounded-xl text-2xl font-bold mb-4" placeholder="0 TL" />
                                <div className="bg-green-50 p-3 rounded-lg flex gap-2 items-center mb-6 text-green-800 text-sm"><Icons.TrendingUp size={16}/> %30 Devlet KatkÄ±sÄ± eklenecek</div>
                                <div className="flex gap-3"><button onClick={() => setSelectedFund(null)} className="flex-1 py-3 text-slate-500 font-bold">Ä°ptal</button><button onClick={executeDeposit} className="flex-1 py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700">YatÄ±r</button></div>
                            </div>
                        </div>
                    )}

                    <header className="bg-white border-b sticky top-0 z-40 px-4 h-16 flex items-center justify-between max-w-5xl mx-auto">
                        <div className="flex items-center gap-2 font-bold text-xl"><Icons.Brain className="text-indigo-600"/> BES<span className="text-indigo-600">AI</span></div>
                        <div className="flex items-center gap-3">
                            <div className="text-right text-sm leading-tight hidden md:block"><div className="text-slate-500">HoÅŸgeldin</div><div className="font-bold">{user.fullName}</div></div>
                            <button onClick={() => setSelectedFund('deposit')} className="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 hover:bg-indigo-700 transition"><Icons.Wallet size={16}/> YatÄ±r</button>
                            <button onClick={() => { localStorage.removeItem('lastBESUser'); setScreen('welcome'); }} className="p-2 text-slate-400 hover:text-red-500"><Icons.LogOut/></button>
                        </div>
                    </header>

                    <main className="max-w-5xl mx-auto p-4 space-y-6">
                        <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                            {[{id: 'dashboard', label: 'Ã–zet', icon: <Icons.Briefcase size={18}/>},{id: 'market', label: 'Fon PazarÄ±', icon: <Icons.Wallet size={18}/>},{id: 'ai', label: 'AI Karar Merkezi', icon: <Icons.Brain size={18}/>},{id: 'simulation', label: 'SimÃ¼lasyon', icon: <Icons.Calculator size={18}/>}].map(t => ( <button key={t.id} onClick={() => setTab(t.id)} className={`flex items-center gap-2 px-4 py-2 rounded-lg font-bold whitespace-nowrap transition ${tab === t.id ? 'bg-slate-900 text-white' : 'bg-white text-slate-500 hover:bg-slate-100'}`}>{t.icon} {t.label}</button> ))}
                        </div>

                        {tab === 'dashboard' && (
                            <div className="animate-fade-in space-y-6">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div className="bg-gradient-to-br from-indigo-600 to-blue-600 text-white p-6 rounded-2xl shadow-lg shadow-indigo-200">
                                        <div className="text-indigo-100 text-sm font-medium">Toplam VarlÄ±k</div>
                                        <div className="text-3xl font-bold">{formatMoney(user.cash + (user.portfolio.reduce((acc, i) => { const f = BES_FUNDS.find(x => x.code === i.code); return acc + (i.units * f.unitPrice); }, 0)))}</div>
                                        <div className="mt-4 flex gap-2 text-xs bg-white/20 p-2 rounded-lg w-fit"><Icons.Shield size={14}/> Devlet KatkÄ±sÄ±: {formatMoney(user.stateContribution)}</div>
                                    </div>
                                    <div className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm">
                                        <div className="text-slate-500 text-sm">Nakit Bakiye</div>
                                        <div className="text-2xl font-bold text-slate-900">{formatMoney(user.cash)}</div>
                                        {user.cash > 1000 && <button onClick={() => setShowBasketModal(true)} className="mt-2 text-xs bg-indigo-50 text-indigo-700 px-2 py-1 rounded font-bold hover:bg-indigo-100">Strateji Uygula</button>}
                                    </div>
                                    
                                    {/* NAKÄ°T EROZYONU KARTI (YENÄ°) */}
                                    {user.cash > 100 ? (
                                        <div className="bg-red-50 p-6 rounded-2xl border border-red-100 shadow-sm">
                                            <div className="text-red-500 text-sm font-bold flex items-center gap-1"><Icons.TrendingDown size={16}/> Enflasyon Etkisi</div>
                                            <div className="text-2xl font-bold text-red-700">-{formatMoney(inflationImpact?.monthlyLoss)} <span className="text-xs font-normal text-red-400">/ay</span></div>
                                            <div className="text-xs text-red-500 mt-1">Nakit paranÄ±zÄ±n alÄ±m gÃ¼cÃ¼ eriyor!</div>
                                        </div>
                                    ) : (
                                        <div className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm">
                                            <div className="text-slate-500 text-sm">PortfÃ¶y Getirisi</div>
                                            <div className={`text-2xl font-bold ${(user.cash + (user.portfolio.reduce((acc, i) => acc + (i.units * BES_FUNDS.find(x => x.code === i.code).unitPrice), 0)) - user.totalDeposited) >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>{formatMoney((user.cash + (user.portfolio.reduce((acc, i) => acc + (i.units * BES_FUNDS.find(x => x.code === i.code).unitPrice), 0)) - user.totalDeposited))}</div>
                                            <div className="text-xs text-slate-400 mt-1">Anapara: {formatMoney(user.totalDeposited)}</div>
                                        </div>
                                    )}
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm h-80">
                                        <h3 className="font-bold mb-4">VarlÄ±k DaÄŸÄ±lÄ±mÄ±</h3>
                                        {user.portfolio.length > 0 ? (
                                            <ResponsiveContainer width="100%" height="100%"><PieChart><Pie data={user.portfolio.map(p => ({ name: BES_FUNDS.find(f => f.code === p.code).category, value: p.units * BES_FUNDS.find(f => f.code === p.code).unitPrice }))} cx="50%" cy="50%" innerRadius={60} outerRadius={80} paddingAngle={5} dataKey="value">{user.portfolio.map((entry, index) => <Cell key={`cell-${index}`} fill={COLORS[BES_FUNDS.find(f => f.code === entry.code)?.category] || '#ccc'} />)}</Pie><Tooltip formatter={(v) => formatMoney(v)} /></PieChart></ResponsiveContainer>
                                        ) : <div className="flex h-full items-center justify-center text-slate-400">PortfÃ¶y boÅŸ</div>}
                                    </div>
                                    
                                    <div className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm">
                                        <h3 className="font-bold mb-4">PortfÃ¶yÃ¼m</h3>
                                        <div className="space-y-3 max-h-60 overflow-y-auto pr-2">
                                            {user.portfolio.length > 0 ? user.portfolio.map(item => { const f = BES_FUNDS.find(x => x.code === item.code); return ( <div key={item.code} className="flex justify-between items-center p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition cursor-pointer border-l-4" style={{ borderLeftColor: COLORS[f.category] || '#ccc' }} onClick={() => setSelectedFund(f)}><div className="pl-2"><div className="font-bold text-slate-900">{f.code}</div><div className="text-xs text-slate-500">{f.name}</div></div><div className="text-right"><div className="font-bold">{formatMoney(item.units * f.unitPrice)}</div><div className="text-xs text-emerald-600">%{(f.return1Y).toFixed(1)} YÄ±llÄ±k</div></div></div> ) }) : <div className="text-center text-slate-400 py-8">Fon bulunmuyor.</div>}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {tab === 'market' && (
                            <div className="animate-fade-in">
                                <div className="flex gap-2 overflow-x-auto pb-4 mb-2">{['TÃ¼mÃ¼', 'AltÄ±n', 'GÃ¼mÃ¼ÅŸ', 'Teknoloji', 'Hisse', 'KatÄ±lÄ±m', 'DeÄŸiÅŸken'].map(c => <button key={c} onClick={() => setCategory(c)} className={`px-4 py-2 rounded-full text-sm font-bold transition ${category === c ? 'bg-slate-900 text-white' : 'bg-white border text-slate-600'}`}>{c}</button>)}</div>
                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">{BES_FUNDS.filter(f => category === 'TÃ¼mÃ¼' || f.category === category).map(f => ( <div key={f.code} onClick={() => setSelectedFund(f)} className="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm hover:shadow-lg hover:border-indigo-200 transition cursor-pointer group"><div className="flex justify-between items-start mb-3"><RiskBadge level={f.riskLevel} /><div className="text-right text-xs text-slate-400">YÄ±llÄ±k <span className="block text-lg font-bold text-emerald-600">%{f.return1Y}</span></div></div><h4 className="font-bold text-slate-800 text-lg group-hover:text-indigo-600 transition">{f.code}</h4><p className="text-sm text-slate-500 line-clamp-1 mb-4">{f.name}</p><div className="flex justify-between items-center pt-4 border-t border-slate-50"><span className="font-mono font-medium">{f.unitPrice} â‚º</span><span className="text-xs bg-slate-100 px-2 py-1 rounded text-slate-600">{f.manager}</span></div></div> ))}</div>
                            </div>
                        )}

                        {tab === 'ai' && (
                            <div className="animate-fade-in grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div className="md:col-span-1 space-y-6">
                                    <div className="bg-indigo-900 text-white p-6 rounded-2xl shadow-lg">
                                        <Icons.Brain size={48} className="mb-4 text-indigo-300"/>
                                        <h3 className="text-xl font-bold mb-2">Yapay Zeka Karar Merkezi</h3>
                                        <p className="text-indigo-200 text-sm mb-4">Sizin iÃ§in binlerce veri noktasÄ±nÄ± analiz edip, ÅŸeffaf kararlar veriyorum.</p>
                                        <div className="space-y-2 text-xs">
                                            <div className="flex justify-between border-b border-indigo-700 pb-1"><span>KullanÄ±lan Algoritma:</span> <span className="font-mono text-indigo-300">RandomForest v2.4</span></div>
                                            <div className="flex justify-between border-b border-indigo-700 pb-1"><span>Analiz Edilen Fon:</span> <span className="font-mono text-indigo-300">324 Adet</span></div>
                                            <div className="flex justify-between"><span>Risk Profiliniz:</span> <span className="font-bold text-white">{getRiskProfile(user.age).level === 'aggressive' ? 'AGRESÄ°F' : 'DENGELÄ°'}</span></div>
                                        </div>
                                    </div>
                                    <div className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm"><h4 className="font-bold mb-4">NasÄ±l Karar Veriyorum?</h4><ul className="space-y-4 text-sm"><li className="flex gap-3"><div className="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center text-green-600 shrink-0">1</div><div><span className="font-bold block">Getiri Analizi</span> Son 1 ve 3 yÄ±llÄ±k performansÄ± enflasyonla kÄ±yaslarÄ±m.</div></li><li className="flex gap-3"><div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 shrink-0">2</div><div><span className="font-bold block">Risk EÅŸleÅŸmesi</span> YaÅŸÄ±nÄ±za uygun volatiliteye sahip fonlarÄ± seÃ§erim.</div></li><li className="flex gap-3"><div className="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center text-purple-600 shrink-0">3</div><div><span className="font-bold block">YÃ¶netici PuanÄ±</span> Fon yÃ¶neticisinin geÃ§miÅŸ baÅŸarÄ±larÄ±nÄ± incelerim.</div></li></ul></div>
                                </div>
                                <div className="md:col-span-2 space-y-4">
                                    <h3 className="font-bold text-lg">AI Analiz & Tavsiyeler</h3>
                                    
                                    {/* AI TAVSÄ°YELERÄ°NÄ° LÄ°STELE */}
                                    {recommendations.map((rec, i) => (
                                        <div key={i} className={`bg-white p-5 rounded-xl border shadow-sm flex flex-col md:flex-row gap-4 items-start ${rec.priority === 'Kritik' ? 'border-red-200 bg-red-50' : 'border-slate-100'}`}>
                                            <div className={`w-12 h-12 rounded-full flex items-center justify-center text-white font-bold shrink-0 ${rec.priority === 'Kritik' ? 'bg-red-500' : 'bg-indigo-600'}`}>
                                                <Icons.Zap size={20}/>
                                            </div>
                                            <div className="flex-1">
                                                <div className="flex gap-2 items-center mb-1">
                                                    <span className={`text-xs font-bold px-2 py-0.5 rounded ${rec.priority === 'Kritik' ? 'bg-red-100 text-red-700' : 'bg-indigo-100 text-indigo-700'}`}>{rec.priority}</span>
                                                    <h4 className="font-bold text-slate-900">{rec.code}</h4>
                                                </div>
                                                <p className="text-sm text-slate-600">{rec.reason}</p>
                                            </div>
                                            {rec.action === 'buy' && rec.code !== 'NAKÄ°T' && <button onClick={() => { setCategory('TÃ¼mÃ¼'); setTab('market'); }} className="px-4 py-2 bg-slate-900 text-white text-sm rounded-lg hover:bg-slate-700">Ä°ncele</button>}
                                            {rec.code === 'NAKÄ°T' && <button onClick={() => setShowBasketModal(true)} className="px-4 py-2 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700">YatÄ±rÄ±m Yap</button>}
                                        </div>
                                    ))}

                                    <h3 className="font-bold text-lg mt-6">En YÃ¼ksek PuanlÄ± Fonlar</h3>
                                    {BES_FUNDS.sort((a,b) => calculateAIScore(b, user.age) - calculateAIScore(a, user.age)).slice(0, 3).map((f, i) => ( <div key={f.code} className="bg-white p-5 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition flex flex-col md:flex-row gap-4 items-start"><div className={`w-16 h-16 rounded-2xl flex flex-col items-center justify-center text-white font-bold shrink-0 ${i===0?'bg-indigo-600': i===1?'bg-indigo-500':'bg-slate-400'}`}><span className="text-2xl">{calculateAIScore(f, user.age)}</span><span className="text-[10px] opacity-80">PUAN</span></div><div className="flex-1"><div className="flex justify-between items-start"><h4 className="font-bold text-lg">{f.name}</h4><button onClick={() => setSelectedFund(f)} className="text-xs bg-slate-100 px-3 py-1 rounded-full font-bold hover:bg-slate-200">Ä°ncele</button></div><div className="flex gap-2 text-xs text-slate-500 mb-2 mt-1"><span>{f.code}</span> â€¢ <span>{f.category}</span></div><div className="bg-slate-50 p-3 rounded-lg text-sm text-slate-600"><span className="font-bold text-indigo-600">AI Notu:</span> {f.sharpe > 1.5 ? ' Riskine gÃ¶re getirisi Ã§ok yÃ¼ksek (Sharpe > 1.5).' : ''} {f.return1Y > 70 ? ' GÃ¼Ã§lÃ¼ momentum yakalamÄ±ÅŸ.' : ''} {f.volatility === 'DÃ¼ÅŸÃ¼k' ? ' GÃ¼venli liman Ã¶zelliÄŸi taÅŸÄ±yor.' : ''}</div></div></div> ))}
                                </div>
                            </div>
                        )}

                        {tab === 'simulation' && (
                            <div className="animate-fade-in bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                                    <div><label className="block text-sm font-bold mb-2">AylÄ±k KatkÄ±: {formatMoney(simMonthly)}</label><input type="range" min="500" max="20000" step="500" value={simMonthly} onChange={e => setSimMonthly(Number(e.target.value))} className="w-full accent-indigo-600"/></div>
                                    <div><label className="block text-sm font-bold mb-2">SÃ¼re: {simYears} YÄ±l</label><input type="range" min="1" max="40" step="1" value={simYears} onChange={e => setSimYears(Number(e.target.value))} className="w-full accent-indigo-600"/></div>
                                </div>
                                <div className="h-80 w-full">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <AreaChart data={simulationData}>
                                            <defs><linearGradient id="colorTahmini" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#4f46e5" stopOpacity={0.8}/><stop offset="95%" stopColor="#4f46e5" stopOpacity={0}/></linearGradient></defs>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false}/>
                                            <XAxis dataKey="year"/>
                                            <YAxis tickFormatter={v => `${v/1000}k`} />
                                            <Tooltip formatter={v => formatMoney(v)} />
                                            <Area type="monotone" dataKey="tahmini" stroke="#4f46e5" fill="url(#colorTahmini)" name="Tahmini Birikim (BES)"/>
                                            <Area type="monotone" dataKey="mevduat" stroke="#ef4444" fill="transparent" strokeDasharray="5 5" name="Sadece Nakit (Eriyen DeÄŸer)"/>
                                        </AreaChart>
                                    </ResponsiveContainer>
                                    <div className="mt-4 text-xs text-center text-slate-500">
                                        <span className="inline-block w-3 h-3 bg-indigo-600 rounded-full mr-1"></span> BES Getirisi
                                        <span className="inline-block w-3 h-3 bg-red-500 rounded-full ml-4 mr-1"></span> Nakit/Mevduat (Enflasyon AltÄ±)
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<BESPortfolio />);
    </script>
</body>
</html>